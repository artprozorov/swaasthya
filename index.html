<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <title>Booking Calendar - Clinic</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            min-height: 100vh;
            padding: 10px;
            color: #333;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
            width: 100%;
        }

        .header {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            padding: 20px;
            text-align: center;
            position: relative;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            word-wrap: break-word;
        }

        .header p {
            font-size: 1em;
            margin: 0;
        }

        .language-switcher {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            gap: 5px;
            background: rgba(255, 255, 255, 0.2);
            padding: 5px;
            border-radius: 8px;
        }

            .language-switcher button {
                padding: 6px 12px;
                background: transparent;
                color: white;
                border: 1px solid rgba(255, 255, 255, 0.3);
                border-radius: 6px;
                font-size: 13px;
                font-weight: 600;
                cursor: pointer;
                transition: all 0.3s;
                min-height: auto;
            }

            .language-switcher button:hover {
                background: rgba(255, 255, 255, 0.2);
                border-color: rgba(255, 255, 255, 0.5);
            }

            .language-switcher button.active {
                background: white;
                color: #10b981;
                border-color: white;
            }

        @media (max-width: 768px) {
            .language-switcher {
                position: static;
                margin-bottom: 10px;
                justify-content: center;
            }
        }

        .controls {
            padding: 15px;
            background: #f8f9fa;
            border-bottom: 2px solid #e9ecef;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            align-items: center;
            justify-content: center;
        }

        .control-group {
            display: flex;
            gap: 8px;
            align-items: center;
            flex-wrap: wrap;
            width: 100%;
            justify-content: center;
        }

        .control-group label {
            font-weight: 600;
            color: #495057;
        }

        select, input[type="date"], input[type="month"] {
            padding: 12px 15px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s;
            width: 100%;
            max-width: 300px;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
        }

        select:focus, input[type="date"]:focus, input[type="month"]:focus {
            outline: none;
            border-color: #10b981;
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
        }

        button {
            padding: 12px 16px;
            background: #10b981;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            min-height: 44px;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
        }

        button:hover {
            background: #047857;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(16, 185, 129, 0.3);
        }

        button:active {
            transform: translateY(0);
        }


        .month-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
            padding: 20px;
        }

        .month-button {
            padding: 15px 25px;
            background: #10b981;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            min-width: 120px;
        }

        .month-button:hover {
            background: #047857;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(16, 185, 129, 0.3);
        }

        .month-button.active {
            background: #065f46;
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.3);
        }

        .calendar-container {
            padding: 10px;
            overflow-x: auto;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        .loading {
            text-align: center;
            padding: 50px;
            font-size: 18px;
            color: #6c757d;
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            margin: 20px;
            border-radius: 8px;
            border: 1px solid #f5c6cb;
        }

        .calendar-table {
            width: 100%;
            min-width: 600px;
            border-collapse: collapse;
            margin-top: 10px;
            background: white;
        }

        .calendar-table th {
            background: #10b981;
            color: white;
            padding: 10px 6px;
            text-align: center;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
            font-size: 12px;
            white-space: nowrap;
        }

        .calendar-table th:first-child {
            position: sticky;
            left: 0;
            z-index: 11;
            background: #047857;
        }

        .calendar-table td {
            border: 1px solid #dee2e6;
            padding: 8px 4px;
            text-align: center;
            min-width: 80px;
            vertical-align: middle;
        }

        .calendar-table td:first-child {
            position: sticky;
            left: 0;
            background: #f8f9fa;
            font-weight: 600;
            z-index: 9;
            white-space: nowrap;
        }

        .booking {
            background: #d1fae5;
            border-left: 4px solid #10b981;
            padding: 6px;
            margin: 2px;
            border-radius: 4px;
            font-size: 11px;
            transition: all 0.2s;
            word-wrap: break-word;
        }

        .booking:hover {
            background: #a7f3d0;
        }

        .date-cell {
            font-weight: 600;
            color: #495057;
            text-align: left;
            padding-left: 10px;
            font-size: 12px;
        }

        .room-cell {
            vertical-align: middle;
        }

        .occupied {
            background: #86efac;
            border-left-color: #4ade80;
        }

        .calendar-table td:not(:first-child) {
            min-width: 100px;
        }

        .calendar-table tbody tr {
            height: 60px;
        }

        .booking-form-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .booking-form-modal.active {
            display: flex;
        }

        .booking-form {
            background: white;
            padding: 20px;
            border-radius: 15px;
            max-width: 500px;
            width: 95%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            -webkit-overflow-scrolling: touch;
        }

        .booking-form h2 {
            margin-bottom: 20px;
            color: #667eea;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #495057;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            font-size: 16px;
            font-family: inherit;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            box-sizing: border-box;
        }

        .form-group textarea {
            min-height: 100px;
            resize: vertical;
        }

        .form-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .btn-secondary {
            background: #6c757d;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .empty-cell {
            color: #adb5bd;
            font-style: italic;
        }

        @media (max-width: 768px) {
            body {
                padding: 5px;
            }

            .container {
                border-radius: 10px;
            }

            .header {
                padding: 15px 10px;
            }

            .header h1 {
                font-size: 1.8em;
                margin-bottom: 5px;
            }

            .header p {
                font-size: 0.9em;
            }

            .controls {
                padding: 10px;
                gap: 8px;
            }

            .control-group {
                flex-direction: column;
                align-items: stretch;
                width: 100%;
                gap: 8px;
            }

            .control-group label {
                font-size: 14px;
            }

            .control-group button {
                width: 100%;
                padding: 14px;
                font-size: 14px;
            }

            .month-buttons {
                padding: 10px;
                gap: 8px;
            }

            .month-button {
                flex: 1 1 calc(50% - 4px);
                min-width: calc(50% - 4px);
                padding: 12px;
                font-size: 14px;
            }

            select, input[type="date"], input[type="month"] {
                width: 100%;
                max-width: 100%;
                padding: 14px;
                font-size: 16px;
            }

            .calendar-container {
                padding: 5px;
            }

            .calendar-table {
                font-size: 11px;
                min-width: 500px;
            }

            .calendar-table th {
                padding: 8px 4px;
                font-size: 10px;
            }

            .calendar-table td {
                padding: 6px 3px;
                min-width: 70px;
            }

            .calendar-table td:first-child {
                min-width: 80px;
                font-size: 10px;
                padding-left: 8px;
            }

            .date-cell {
                font-size: 10px;
                padding-left: 8px;
            }

            .booking {
                font-size: 10px;
                padding: 4px;
            }

            .empty-cell {
                font-size: 10px;
            }

            .booking-form {
                padding: 15px;
                width: 98%;
                max-height: 95vh;
            }

            .booking-form h2 {
                font-size: 1.3em;
                margin-bottom: 15px;
            }

            .form-group {
                margin-bottom: 15px;
            }

            .form-group label {
                font-size: 14px;
                margin-bottom: 6px;
            }

            .form-group input,
            .form-group select,
            .form-group textarea {
                padding: 14px;
                font-size: 16px;
            }

            .form-actions {
                flex-direction: column;
            }

            .form-actions button {
                width: 100%;
                margin: 0;
            }
        }

        @media (max-width: 480px) {
            .header h1 {
                font-size: 1.5em;
            }

            .month-button {
                flex: 1 1 100%;
                min-width: 100%;
                padding: 14px;
            }

            .calendar-table {
                min-width: 450px;
            }

            .calendar-table th {
                font-size: 9px;
                padding: 6px 3px;
            }

            .calendar-table td {
                padding: 5px 2px;
                min-width: 60px;
            }

            .booking {
                font-size: 9px;
                padding: 3px;
            }

            .date-cell {
                font-size: 9px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="language-switcher">
                <button id="langEn" onclick="switchLanguage('en')" class="active">EN</button>
                <button id="langRu" onclick="switchLanguage('ru')">RU</button>
            </div>
            <h1 data-i18n="header.title">üìÖ Booking Calendar</h1>
            <p data-i18n="header.subtitle">View room availability in the clinic</p>
        </div>

        <div class="controls">
            <div class="control-group">
                <h3 data-i18n="controls.selectMonth">Select Month:</h3>
            </div>
            <div class="month-buttons" id="monthButtons">
                <!-- Month buttons will be generated here -->
            </div>
        </div>

        <div class="calendar-container">
            <div id="loading" class="loading" data-i18n="loading">
                Loading data...
            </div>
            <div id="error" class="error" style="display: none;"></div>
            <div id="calendar" style="display: none;"></div>
        </div>
    </div>

    <!-- Booking form modal -->
    <div id="bookingModal" class="booking-form-modal">
        <div class="booking-form">
            <h2 data-i18n="form.title">Send Booking Request</h2>
            <form id="bookingForm" onsubmit="sendBookingRequest(event)">
                <div class="form-group">
                    <label for="bookingDate" data-i18n="form.bookingDate">Booking Date:</label>
                    <input type="date" id="bookingDate" name="bookingDate" required>
                </div>

                <div class="form-group">
                    <label for="bookingRoom" data-i18n="form.room">Room:</label>
                    <select id="bookingRoom" name="bookingRoom" required>
                        <option value="" data-i18n="form.selectRoom">Select a room...</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="bookingName" data-i18n="form.yourName">Your Name:</label>
                    <input type="text" id="bookingName" name="bookingName" required>
                </div>

                <div class="form-group">
                    <label for="bookingEmail" data-i18n="form.yourEmail">Your Email:</label>
                    <input type="email" id="bookingEmail" name="bookingEmail" required>
                </div>

                <div class="form-group">
                    <label for="bookingPhone" data-i18n="form.phone">Phone:</label>
                    <input type="tel" id="bookingPhone" name="bookingPhone" required>
                </div>

                <div class="form-group">
                    <label for="bookingNotes" data-i18n="form.additionalInfo">Additional Information:</label>
                    <textarea id="bookingNotes" name="bookingNotes" data-i18n-placeholder="form.additionalInfoPlaceholder" placeholder="Please provide any additional details..."></textarea>
                </div>

                <div class="form-group">
                    <label for="recipientEmail" data-i18n="form.recipientEmail">Recipient Email:</label>
                    <input type="email" id="recipientEmail" name="recipientEmail" placeholder="email@example.com" required>
                </div>

                <div class="form-actions">
                    <button type="button" class="btn-secondary" onclick="closeBookingForm()" data-i18n="form.cancel">Cancel</button>
                    <button type="submit" data-i18n="form.sendRequest">Send Request</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Language translations
        const translations = {
            en: {
                header: {
                    title: 'üìÖ Booking Calendar',
                    subtitle: 'View room availability in the clinic'
                },
                controls: {
                    month: 'Month:',
                    selectMonth: 'Select Month:',
                    prevMonth: '‚Üê Previous Month',
                    currentMonth: 'Current Month',
                    nextMonth: 'Next Month ‚Üí',
                    bookRoom: 'üìß Book Room'
                },
                loading: 'Loading data...',
                occupied: 'Occupied',
                available: 'Available',
                date: 'Date',
                form: {
                    title: 'Send Booking Request',
                    bookingDate: 'Booking Date:',
                    room: 'Room:',
                    selectRoom: 'Select a room...',
                    yourName: 'Your Name:',
                    yourEmail: 'Your Email:',
                    phone: 'Phone:',
                    additionalInfo: 'Additional Information:',
                    additionalInfoPlaceholder: 'Please provide any additional details...',
                    recipientEmail: 'Recipient Email:',
                    cancel: 'Cancel',
                    sendRequest: 'Send Request'
                },
                errors: {
                    httpError: 'HTTP error! status:',
                    invalidFormat: 'Invalid data format. Expected an array of objects.',
                    loadingError: 'Error loading data:',
                    solutions: 'Solutions:',
                    checkInternet: '1. Check your internet connection',
                    checkUrl: '2. Verify the API URL in the code',
                    checkConsole: '3. Check the browser console (F12) for details',
                    checkData: '4. Make sure the JSON API returns valid data'
                },
                success: {
                    requestSent: 'Request sent! Your email client will open.',
                    bookingRequest: 'Booking Request',
                    date: 'Date:',
                    room: 'Room:',
                    name: 'Name:',
                    email: 'Email:',
                    phone: 'Phone:',
                    additionalInfo: 'Additional Information:'
                }
            },
            ru: {
                header: {
                    title: 'üìÖ –ö–∞–ª–µ–Ω–¥–∞—Ä—å –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è',
                    subtitle: '–ü—Ä–æ—Å–º–æ—Ç—Ä –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –∫–æ–º–Ω–∞—Ç –≤ –∫–ª–∏–Ω–∏–∫–µ'
                },
                controls: {
                    month: '–ú–µ—Å—è—Ü:',
                    selectMonth: '–í—ã–±–µ—Ä–∏—Ç–µ –º–µ—Å—è—Ü:',
                    prevMonth: '‚Üê –ü—Ä–µ–¥—ã–¥—É—â–∏–π –º–µ—Å—è—Ü',
                    currentMonth: '–¢–µ–∫—É—â–∏–π –º–µ—Å—è—Ü',
                    nextMonth: '–°–ª–µ–¥—É—é—â–∏–π –º–µ—Å—è—Ü ‚Üí',
                    bookRoom: 'üìß –ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å'
                },
                loading: '–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...',
                occupied: '–ó–∞–Ω—è—Ç–æ',
                available: '–°–≤–æ–±–æ–¥–Ω–æ',
                date: '–î–∞—Ç–∞',
                form: {
                    title: '–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞—è–≤–∫—É –Ω–∞ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ',
                    bookingDate: '–î–∞—Ç–∞ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è:',
                    room: '–ö–æ–º–Ω–∞—Ç–∞:',
                    selectRoom: '–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–º–Ω–∞—Ç—É...',
                    yourName: '–í–∞—à–µ –∏–º—è:',
                    yourEmail: '–í–∞—à email:',
                    phone: '–¢–µ–ª–µ—Ñ–æ–Ω:',
                    additionalInfo: '–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è:',
                    additionalInfoPlaceholder: '–£–∫–∞–∂–∏—Ç–µ –ª—é–±—ã–µ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –¥–µ—Ç–∞–ª–∏...',
                    recipientEmail: 'Email –ø–æ–ª—É—á–∞—Ç–µ–ª—è:',
                    cancel: '–û—Ç–º–µ–Ω–∞',
                    sendRequest: '–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞—è–≤–∫—É'
                },
                errors: {
                    httpError: 'HTTP –æ—à–∏–±–∫–∞! —Å—Ç–∞—Ç—É—Å:',
                    invalidFormat: '–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–∞–Ω–Ω—ã—Ö. –û–∂–∏–¥–∞–µ—Ç—Å—è –º–∞—Å—Å–∏–≤ –æ–±—ä–µ–∫—Ç–æ–≤.',
                    loadingError: '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö:',
                    solutions: '–†–µ—à–µ–Ω–∏—è:',
                    checkInternet: '1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É',
                    checkUrl: '2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å URL API –≤ –∫–æ–¥–µ',
                    checkConsole: '3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Å–æ–ª—å –±—Ä–∞—É–∑–µ—Ä–∞ (F12) –¥–ª—è –ø–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–µ–π',
                    checkData: '4. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ JSON API –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ'
                },
                success: {
                    requestSent: '–ó–∞—è–≤–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞! –û—Ç–∫—Ä–æ–µ—Ç—Å—è –≤–∞—à –ø–æ—á—Ç–æ–≤—ã–π –∫–ª–∏–µ–Ω—Ç.',
                    bookingRequest: '–ó–∞—è–≤–∫–∞ –Ω–∞ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ',
                    date: '–î–∞—Ç–∞:',
                    room: '–ö–æ–º–Ω–∞—Ç–∞:',
                    name: '–ò–º—è:',
                    email: 'Email:',
                    phone: '–¢–µ–ª–µ—Ñ–æ–Ω:',
                    additionalInfo: '–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è:'
                }
            }
        };

        // Current language (default: English) - MUST be set before any rendering
        let currentLang = 'en';
        document.documentElement.lang = 'en';

        // Switch language function
        function switchLanguage(lang) {
            currentLang = lang;
            document.documentElement.lang = lang;
            
            // Update language switcher buttons
            document.getElementById('langEn').classList.toggle('active', lang === 'en');
            document.getElementById('langRu').classList.toggle('active', lang === 'ru');
            
            // Update all elements with data-i18n attribute
            document.querySelectorAll('[data-i18n]').forEach(element => {
                const key = element.getAttribute('data-i18n');
                const keys = key.split('.');
                let translation = translations[lang];
                for (const k of keys) {
                    translation = translation[k];
                }
                if (translation) {
                    element.textContent = translation;
                }
            });
            
            // Update placeholders
            document.querySelectorAll('[data-i18n-placeholder]').forEach(element => {
                const key = element.getAttribute('data-i18n-placeholder');
                const keys = key.split('.');
                let translation = translations[lang];
                for (const k of keys) {
                    translation = translation[k];
                }
                if (translation) {
                    element.placeholder = translation;
                }
            });
            
            // Update month buttons and calendar if it's already rendered
            if (rooms.length > 0) {
                renderMonthButtons();
                renderCalendar();
            }
            
            // Update room select
            if (rooms.length > 0) {
                populateRoomSelect();
            }
        }

        // Get translation helper
        function t(key) {
            const keys = key.split('.');
            let translation = translations[currentLang];
            for (const k of keys) {
                translation = translation[k];
            }
            return translation || key;
        }

        // Format date without relying on browser locale
        function formatDateLocalized(date, lang) {
            const weekdaysEn = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            const weekdaysRu = ['–í—Å', '–ü–Ω', '–í—Ç', '–°—Ä', '–ß—Ç', '–ü—Ç', '–°–±'];
            const monthsEn = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            const monthsRu = ['—è–Ω–≤', '—Ñ–µ–≤', '–º–∞—Ä', '–∞–ø—Ä', '–º–∞–π', '–∏—é–Ω', '–∏—é–ª', '–∞–≤–≥', '—Å–µ–Ω', '–æ–∫—Ç', '–Ω–æ—è', '–¥–µ–∫'];
            
            const day = date.getDate();
            const weekday = date.getDay();
            const month = date.getMonth();
            
            if (lang === 'ru') {
                return `${weekdaysRu[weekday]}, ${day} ${monthsRu[month]}`;
            } else {
                // Default to English
                return `${weekdaysEn[weekday]}, ${day} ${monthsEn[month]}`;
            }
        }

        // Configuration
        // JSON API endpoint for fetching booking data
        const JSON_API_URL = 'https://script.googleusercontent.com/macros/echo?user_content_key=AehSKLgpQ7TCxRy8hossqgYTss3VdHS_asGnOO7gOzTH3Es8CLgv4gk3Natyq77q9IhTVvYSJynnQ7SHkl-2USPd_qJRzhYVZYe_pTu3rRkA3biUZB29aS9abIXUxShH6I5EHqSZigqbfpIfpTUD_OcIYmc7yVarEDHD1uzydzCSdqA57PdhtG6PNFImZePEvhVC4MIUavv0KZ3mxRtXh8bSsv82p-b6YwiRbitutQ18lRoIpBBZBiCa0mhTjqZq5K6lemGsAtw52iw0RcsKvdWx_6qG2CI-Ly6AoTb-Nfmg&lib=MGTsziAHfjwhGehBTxGbzrA5sAQzR7ekx';
        
        let bookingsData = [];
        let rooms = [];
        let currentStartDate = new Date();

        // –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –¥–∞—Ç–∞ - —è–Ω–≤–∞—Ä—å 2026
        const MIN_DATE = new Date(2026, 0, 1); // –Ø–Ω–≤–∞—Ä—å 2026

        // Initialization
        document.addEventListener('DOMContentLoaded', function() {
            // Set default language to English FIRST, before anything else
            currentLang = 'en';
            document.documentElement.lang = 'en';
            switchLanguage('en');
            
            // Always start with January 2026
            currentStartDate = new Date(2026, 0, 1); // January 2026
            
            // Render month buttons
            renderMonthButtons();
            
            loadBookings();
        });

        // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∏–∑ Google Sheets —á–µ—Ä–µ–∑ JSON API
        async function loadBookings() {
            const loadingEl = document.getElementById('loading');
            const errorEl = document.getElementById('error');
            const calendarEl = document.getElementById('calendar');
            
            loadingEl.style.display = 'block';
            errorEl.style.display = 'none';
            calendarEl.style.display = 'none';

            try {
                const response = await fetch(JSON_API_URL);
                if (!response.ok) {
                    throw new Error(`${t('errors.httpError')} ${response.status}`);
                }
                
                const data = await response.json();
                
                if (!Array.isArray(data)) {
                    throw new Error(t('errors.invalidFormat'));
                }
                
                bookingsData = data;
                rooms = extractRooms(data);
                populateRoomSelect();
                
                loadingEl.style.display = 'none';
                calendarEl.style.display = 'block';
                // Ensure English is set before rendering
                if (currentLang !== 'en') {
                    currentLang = 'en';
                    document.documentElement.lang = 'en';
                }
                // Render month buttons and calendar
                renderMonthButtons();
                renderCalendar();
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:', error);
                loadingEl.style.display = 'none';
                errorEl.style.display = 'block';
                errorEl.innerHTML = `
                    <strong>${t('errors.loadingError')}</strong> ${error.message}<br><br>
                    <strong>${t('errors.solutions')}</strong><br>
                    ${t('errors.checkInternet')}<br>
                    ${t('errors.checkUrl')}<br>
                    ${t('errors.checkConsole')}<br>
                    ${t('errors.checkData')}
                `;
            }
        }

        // –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –∫–æ–º–Ω–∞—Ç –∏–∑ JSON –¥–∞–Ω–Ω—ã—Ö
        function extractRooms(data) {
            if (data.length === 0) return [];
            
            // –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ –∫–ª—é—á–∏ –∏–∑ –ø–µ—Ä–≤–æ–≥–æ –æ–±—ä–µ–∫—Ç–∞, –∏—Å–∫–ª—é—á–∞—è DATE
            const headers = Object.keys(data[0]);
            // –ò—Å–∫–ª—é—á–∞–µ–º –ø–æ–ª–µ DATE, –æ—Å—Ç–∞–ª—å–Ω—ã–µ - –∫–æ–º–Ω–∞—Ç—ã
            return headers.filter(room => room !== 'DATE' && room.trim() !== '');
        }

        // Render month buttons for 2026
        function renderMonthButtons() {
            const monthButtonsEl = document.getElementById('monthButtons');
            const months = [
                { num: 0, nameEn: 'January', nameRu: '–Ø–Ω–≤–∞—Ä—å' },
                { num: 1, nameEn: 'February', nameRu: '–§–µ–≤—Ä–∞–ª—å' },
                { num: 2, nameEn: 'March', nameRu: '–ú–∞—Ä—Ç' },
                { num: 3, nameEn: 'April', nameRu: '–ê–ø—Ä–µ–ª—å' },
                { num: 4, nameEn: 'May', nameRu: '–ú–∞–π' },
                { num: 5, nameEn: 'June', nameRu: '–ò—é–Ω—å' },
                { num: 6, nameEn: 'July', nameRu: '–ò—é–ª—å' },
                { num: 7, nameEn: 'August', nameRu: '–ê–≤–≥—É—Å—Ç' },
                { num: 8, nameEn: 'September', nameRu: '–°–µ–Ω—Ç—è–±—Ä—å' },
                { num: 9, nameEn: 'October', nameRu: '–û–∫—Ç—è–±—Ä—å' },
                { num: 10, nameEn: 'November', nameRu: '–ù–æ—è–±—Ä—å' },
                { num: 11, nameEn: 'December', nameRu: '–î–µ–∫–∞–±—Ä—å' }
            ];
            
            let html = '';
            months.forEach(month => {
                const isActive = currentStartDate.getMonth() === month.num && currentStartDate.getFullYear() === 2026;
                const monthName = currentLang === 'ru' ? month.nameRu : month.nameEn;
                html += `<button class="month-button ${isActive ? 'active' : ''}" onclick="selectMonth(${month.num})">${monthName} 2026</button>`;
            });
            
            monthButtonsEl.innerHTML = html;
        }

        // Select month
        function selectMonth(monthIndex) {
            currentStartDate = new Date(2026, monthIndex, 1);
            renderMonthButtons();
            renderCalendar();
        }

        // Update calendar (kept for compatibility)
        function updateCalendar() {
            renderMonthButtons();
            renderCalendar();
        }

        // Render calendar for selected month
        function renderCalendar() {
            // Ensure language is set (default to English) - force English if not explicitly Russian
            if (!currentLang || currentLang === '' || currentLang !== 'ru') {
                currentLang = 'en';
            }
            
            const calendarEl = document.getElementById('calendar');
            
            const endDate = new Date(currentStartDate);
            endDate.setMonth(endDate.getMonth() + 1);
            endDate.setDate(0); // –ü–æ—Å–ª–µ–¥–Ω–∏–π –¥–µ–Ω—å –º–µ—Å—è—Ü–∞
            
            // –§–æ—Ä–º–∏—Ä—É–µ–º —Å–ø–∏—Å–æ–∫ –¥–∞—Ç
            const dates = [];
            const date = new Date(currentStartDate);
            while (date <= endDate) {
                dates.push(new Date(date));
                date.setDate(date.getDate() + 1);
            }
            
            // Start building table
            let html = `<table class="calendar-table"><thead><tr><th>${t('date')}</th>`;
            
            // –ó–∞–≥–æ–ª–æ–≤–∫–∏ —Å –∫–æ–º–Ω–∞—Ç–∞–º–∏
            rooms.forEach(room => {
                html += `<th>${room}</th>`;
            });
            
            html += '</tr></thead><tbody>';
            
            // –°—Ç—Ä–æ–∫–∏ –¥–ª—è –∫–∞–∂–¥–æ–π –¥–∞—Ç—ã
            dates.forEach(day => {
                const dayStr = formatDate(day);
                // Use custom date formatting that doesn't depend on browser locale
                // Always defaults to English unless explicitly Russian
                const lang = (currentLang === 'ru') ? 'ru' : 'en';
                const dateStr = formatDateLocalized(day, lang);
                
                html += `<tr><td class="date-cell">${dateStr}</td>`;
                
                // –Ø—á–µ–π–∫–∏ –¥–ª—è –∫–∞–∂–¥–æ–π –∫–æ–º–Ω–∞—Ç—ã –Ω–∞ —ç—Ç—É –¥–∞—Ç—É
                rooms.forEach(room => {
                    const isOccupied = isRoomOccupied(room, dayStr);
                    
                    html += '<td class="room-cell">';
                    
                    if (isOccupied) {
                        // Anonymization: show only occupancy status
                        html += `<div class="booking occupied">${t('occupied')}</div>`;
                    } else {
                        html += `<div class="empty-cell">${t('available')}</div>`;
                    }
                    
                    html += '</td>';
                });
                
                html += '</tr>';
            });
            
            html += '</tbody></table>';
            calendarEl.innerHTML = html;
        }

        // Check if room is occupied on specified date
        function isRoomOccupied(room, dateStr) {
            for (const row of bookingsData) {
                const rowDate = row.DATE;
                const formattedRowDate = formatDateStr(rowDate);
                
                // Debug: log to see what's happening
                // console.log('Checking:', { room, dateStr, formattedRowDate, rowDate, roomStatus: row[room] });
                
                // Check if date matches
                if (formattedRowDate === dateStr) {
                    const roomStatus = row[room];
                    // Room is occupied if value is strictly true (boolean)
                    if (roomStatus === true) {
                        return true;
                    }
                }
            }
            return false;
        }

        // –ü–æ–ª—É—á–µ–Ω–∏–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π –¥–ª—è –∫–æ–º–Ω–∞—Ç—ã –∏ –¥–∞—Ç—ã (–æ—Å—Ç–∞–≤–ª–µ–Ω–æ –¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏)
        function getBookingsForRoomAndDate(room, dateStr) {
            return bookingsData.filter(row => {
                const rowDate = row.DATE;
                const formattedRowDate = formatDateStr(rowDate);
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –¥–∞—Ç–∞ —Å–æ–≤–ø–∞–¥–∞–µ—Ç –∏ –∫–æ–º–Ω–∞—Ç–∞ –∑–∞–Ω—è—Ç–∞ (true)
                if (formattedRowDate !== dateStr) return false;
                
                const roomStatus = row[room];
                // –ö–æ–º–Ω–∞—Ç–∞ –∑–∞–Ω—è—Ç–∞, –µ—Å–ª–∏ –∑–Ω–∞—á–µ–Ω–∏–µ === true
                return roomStatus === true;
            });
        }

        // Format date to YYYY-MM-DD (using UTC to avoid timezone issues)
        function formatDate(date) {
            // Use UTC methods to avoid timezone shifts
            const year = date.getUTCFullYear();
            const month = String(date.getUTCMonth() + 1).padStart(2, '0');
            const day = String(date.getUTCDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        // Format date string (work with ISO format from JSON)
        function formatDateStr(dateValue) {
            if (!dateValue) return '';
            
            let date;
            
            // If it's already a Date object
            if (dateValue instanceof Date) {
                date = dateValue;
            }
            // If it's an ISO string (e.g., "2025-06-24T21:00:00.000Z")
            else if (typeof dateValue === 'string') {
                // Parse the date string and extract just the date part to avoid timezone issues
                // Extract YYYY-MM-DD from ISO string before creating Date object
                const dateMatch = dateValue.match(/^(\d{4})-(\d{2})-(\d{2})/);
                if (dateMatch) {
                    // Create date in UTC to avoid timezone shifts
                    const year = parseInt(dateMatch[1]);
                    const month = parseInt(dateMatch[2]) - 1; // Month is 0-indexed
                    const day = parseInt(dateMatch[3]);
                    date = new Date(Date.UTC(year, month, day));
                } else {
                    date = new Date(dateValue);
                }
            }
            else {
                return '';
            }
            
            if (isNaN(date.getTime())) {
                return '';
            }
            
            // Return date in YYYY-MM-DD format (date only, no time)
            return formatDate(date);
        }

        // Update calendar (kept for compatibility, but now just calls renderCalendar)
        function updateCalendar() {
            renderMonthButtons();
            renderCalendar();
        }

        // Booking form handling
        function populateRoomSelect() {
            const select = document.getElementById('bookingRoom');
            // Clear existing options except the first one
            const firstOption = select.querySelector('option[value=""]');
            select.innerHTML = '';
            
            // Add the select placeholder option
            const placeholderOption = document.createElement('option');
            placeholderOption.value = '';
            placeholderOption.textContent = t('form.selectRoom');
            select.appendChild(placeholderOption);
            
            // Add room options
            rooms.forEach(room => {
                const option = document.createElement('option');
                option.value = room;
                option.textContent = room;
                select.appendChild(option);
            });
        }

        function openBookingForm() {
            document.getElementById('bookingModal').classList.add('active');
            // –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–µ–≥–æ–¥–Ω—è—à–Ω—é—é –¥–∞—Ç—É –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
            document.getElementById('bookingDate').valueAsDate = new Date();
        }

        function closeBookingForm() {
            document.getElementById('bookingModal').classList.remove('active');
            document.getElementById('bookingForm').reset();
        }

        function sendBookingRequest(event) {
            event.preventDefault();
            
            const formData = new FormData(event.target);
            const bookingDate = formData.get('bookingDate');
            const bookingRoom = formData.get('bookingRoom');
            const bookingName = formData.get('bookingName');
            const bookingEmail = formData.get('bookingEmail');
            const bookingPhone = formData.get('bookingPhone');
            const bookingNotes = formData.get('bookingNotes');
            const recipientEmail = formData.get('recipientEmail');
            
            // Format email subject and body
            const subject = encodeURIComponent(`${t('success.bookingRequest')} - ${bookingRoom}`);
            const body = encodeURIComponent(
                `${t('success.bookingRequest')}\n\n` +
                `${t('success.date')} ${bookingDate}\n` +
                `${t('success.room')} ${bookingRoom}\n` +
                `${t('success.name')} ${bookingName}\n` +
                `${t('success.email')} ${bookingEmail}\n` +
                `${t('success.phone')} ${bookingPhone}\n` +
                `${bookingNotes ? `${t('success.additionalInfo')} ${bookingNotes}` : ''}`
            );
            
            // Open email client
            const mailtoLink = `mailto:${recipientEmail}?subject=${subject}&body=${body}`;
            window.location.href = mailtoLink;
            
            // Close form
            closeBookingForm();
            
            // Show success message
            alert(t('success.requestSent'));
        }
    </script>
</body>
</html>
